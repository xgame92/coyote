<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://microsoft.github.io/coyote/how-to/coverage/">
    <link rel="shortcut icon" href="/coyote/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Track code and actor activity coverage - Coyote</title>
    <link href="/coyote/css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="/coyote/css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="/coyote/css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="/coyote/css/highlight.css">
    <link href="../../css/main.css" rel="stylesheet">
    <link href="../../css/player-controls.css" rel="stylesheet">
    <link href="../../css/syntax.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="/coyote/js/jquery-3.2.1.min.js"></script>
    <script src="/coyote/js/bootstrap-3.3.7.min.js"></script>
    <script src="/coyote/js/highlight.pack.js"></script>
    <script src="https://consentdeliveryfd.azurefd.net/mscc/lib/v2/wcp-consent.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '/coyote/';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Track code and actor activity coverage", url: "#_top", children: [
              {title: "Coyote coverage options", url: "#coyote-coverage-options" },
              {title: "Output file locations", url: "#output-file-locations" },
              {title: "Actor activity coverage", url: "#actor-activity-coverage" },
              {title: "Definition of event coverage", url: "#definition-of-event-coverage" },
              {title: "Activity coverage output files", url: "#activity-coverage-output-files" },
              {title: "Activity coverage visualization example", url: "#activity-coverage-visualization-example" },
              {title: "Code coverage", url: "#code-coverage" },
              {title: "Code coverage binary instrumentation", url: "#code-coverage-binary-instrumentation" },
              {title: "Code coverage output files", url: "#code-coverage-output-files" },
              {title: "Coyote test examples", url: "#coyote-test-examples" },
              {title: "Troubleshooting", url: "#troubleshooting" },
          ]},
        ];

    </script>
    <script src="/coyote/js/base.js"></script>
      <script src="../../assets/js/analytics.js"></script>
      <script src="../../assets/js/plugins.js"></script>
      <script src="../../assets/js/animate_trace.js"></script>
      <script src="../../assets/js/animation.js"></script>
      <script src="../../assets/js/progress_bar.js"></script>
      <script src="../../assets/js/trace_model.js"></script>
      <script src="../../assets/js/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>

<div id="cookie-banner"></div>


<div class="wrapper wm-page-content">
  <div class="container-fluid">
    <a name="_top"></a>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../generate-dgml/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../generate-dgml/" class="btn btn-xs btn-link">
        Generate DGML diagrams
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../liveness-checking/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../liveness-checking/" class="btn btn-xs btn-link">
        Find liveness bugs effectively
      </a>
    </div>
    
  </div>

      

      <h2 id="track-code-and-actor-activity-coverage">Track code and actor activity coverage</h2>
<p>Standard code coverage tools record the percentage of code lines that are actually executed by test
cases. Coyote additionally defines the higher-level metric <em>Actor Activity Coverage</em> that reports
state transitions and the percentage of possible events that are actually executed during a run of
<code>coyote</code> tester.</p>
<h3 id="coyote-coverage-options">Coyote coverage options</h3>
<p>Running <code>coyote /?</code> displays a summary of command-line options. Here is the section describing
options to report code and activity coverage:</p>
<pre><code class="language-plain">Code and activity coverage options:
-----------------------------------
  -c, --coverage string       
        : Generate code coverage statistics (via VS instrumentation) with zero
          or more values equal to:
            code: Generate code coverage statistics (via VS instrumentation)
            activity: Generate activity (state machine, event, etc.) coverage statistics
            activity-debug: Print activity coverage statistics with debug info
  -instr, --instrument string
        : Additional file spec(s) to instrument for code coverage (wildcards
          supported)
  -instr-list, --instrument-list string
        : File containing the paths to additional file(s) to instrument for
          code coverage, one per line, wildcards supported, lines starting
          with '//' are skipped
</code></pre>
<p>Detailed descriptions are provided in subsequent sections. The following provides a quick overview.</p>
<ul>
<li>Note that <code>--coverage</code> is the equivalent of specifying <code>--coverage code activity</code>.</li>
<li>If <code>--coverage</code> or <code>--coverage code</code> is specified, all DLLs in the dependency chain between the
  assembly being tested (specified by the <code>path</code> argument) and any <code>Microsoft.Coyote.*.dll</code> are
  instrumented to collect code coverage data.</li>
<li>The <code>--instrument</code> options allow you specify other DLLs that don&rsquo;t depend on Coyote but should
  also be instrumented (for example, utility libraries). File names can be absolute or relative to
  the assembly being tested (specified by the <code>path</code> argument).</li>
<li><code>--coverage activity</code> and <code>--coverage activity-debug</code> do not instrument assemblies. In this case
  Coyote maintains the history of events and state transitions for reporting the coverage of the
  actors and state machines being tested.</li>
</ul>
<h3 id="output-file-locations">Output file locations</h3>
<p>By default, at the end of testing the report files are written to a directory named
<code>Output/[assemblyToTest]/CoyoteOutput</code> in the directory specified by the <code>path</code> argument. If
<code>--outdir outputDirectory</code> is specified, then the files are written to the directory
<code>[outputDirectory]/CoyoteOutput</code>.</p>
<p>Details of the report files that are created for the separate coverage types are provided in
subsequent sections.</p>
<h3 id="actor-activity-coverage">Actor activity coverage</h3>
<p>Actor activity coverage includes event coverage, which is defined in the following section, as well
as a summary of states that were entered and exited and which state transitions occurred.</p>
<h3 id="definition-of-event-coverage">Definition of event coverage</h3>
<p>A tuple <code>(M, S, E)</code> is said to be <em>defined</em> if state S of machine M is prepared to receive an event
of type E, i.e., it has an action defined for the event.</p>
<p>A tuple <code>(M, S, E)</code> is said to be <em>covered</em> by a test run if state S of machine M actually dequeues
an event of type E during an execution.</p>
<p>Event coverage is the number of tuples covered divided by the number of tuples defined in the
program. The higher this metric, the better testing exercised all these combinations in the
program. As with other coverage metrics, obtaining 100% coverage may be unrealistic as it depends
on the particular test harness being used.</p>
<h3 id="activity-coverage-output-files">Activity coverage output files</h3>
<p>If the option <code>--coverage</code>, <code>--coverage activity</code>, or <code>--coverage activity-debug</code> is passed to
<code>coyote</code>, the following files will be written to the <a href="#output-file-locations">output directory</a> (for
example, given <code>path</code> equal to <code>PingPong.exe</code>):
* <code>PingPong.coverage.txt</code>. This file contains the Event Coverage metric along with a breakdown per
  machine and per state. It also summarizes other useful coverage information.
* <code>PingPong.dgml</code>. This file contains the Event Coverage visualization as described below.
* <code>PingPong.sci</code>. This is the serialized <code>CoverageInfo</code> object for the test run. Such &lsquo;sci&rsquo; files
  from multiple runs can be passed to <code>CoyoteCoverageReportMerger.exe</code> to create a merged report.
* If <code>--coverage activity-debug</code> was specified, then there will also be a Debug directory containing
  the same files as above for each process, with the filename qualified by a sequential process id,
  e.g: <code>PingPong.coverage_0.txt</code></p>
<p>Note that while <code>--coverage</code> is a shortcut for specifying both <code>--coverage code</code> and <code>--coverage
activity</code>, you must specify <code>--coverage activity-debug</code> explicitly.</p>
<h3 id="activity-coverage-visualization-example">Activity coverage visualization example</h3>
<p>The activity coverage can additionally be displayed in <a href="../generate-dgml/">DGML diagram</a> format. Run
<code>coyote</code> as described in the <a href="#coyote-test-examples"><code>coyote</code> examples</a> section below. This produces
a file in the DGML format as described in the <a href="#activity-coverage-output-files">activity coverage output
files</a> section. Open the file using Visual Studio. It captures
machines, states and transitions witnessed during the testing of the program. The file also contains
inter-machine transitions. These transitions are usually auto-hidden when opened in Visual Studio,
but visible when you click on a state.</p>
<h3 id="code-coverage">Code coverage</h3>
<p>For code coverage, <code>coyote</code> instruments the <code>path</code> assembly and the binaries it depends upon via
<code>VSInstr.exe</code>. <code>VSPerfCmd.exe</code> is launched while the test runs, and is terminated when the test is
complete.</p>
<p>For code coverage to work you must ensure your project is built using <strong>Full PDBs</strong> which you can
do by specifying the following build properties:</p>
<pre><code class="language-xml">&lt;PropertyGroup&gt;
  &lt;DebugType&gt;full&lt;/DebugType&gt;
  &lt;DebugSymbols&gt;true&lt;/DebugSymbols&gt;
&lt;/PropertyGroup&gt;
</code></pre>
<p><code>VSPerfCmd.exe</code> collects data from all running processes, so do not run multiple coverage tests at
the same time.</p>
<h3 id="code-coverage-binary-instrumentation">Code coverage binary instrumentation</h3>
<p><code>coyote</code> instruments the following binaries (via <code>VSInstr.exe</code>):
* <code>path</code>: this is the path to the assembly that is being tested.
* Each DLL in the dependency graph of the assembly specified by the <code>path</code> argument - not including
  <code>Microsoft.Coyote.dll</code>, <code>mscorlib</code> or any <code>System*</code> assemblies.
* Any additional assemblies specified by one of the <code>--instrument</code> or <code>--instrument-list</code> options.</p>
<p>By default the VS 2019 tools are used. These are set in <code>coyote.exe.config</code> and are based on the
environment variable $(DevEnvDir) which is automatically defined if you use a Visual Studio
Developer Command Prompt. The actual paths can be overridden by environment variables with the same
names as the app settings:</p>
<ul>
<li><code>VSInstrToolPath</code></li>
<li><code>VSPerfCmdToolPath</code></li>
</ul>
<h3 id="code-coverage-output-files">Code coverage output files</h3>
<p>If the option <code>--coverage</code> or <code>--coverage code</code> is passed to <code>coyote</code>, the following files will be
written to the <a href="#output-file-locations">output directory</a> (for example, if <code>path</code> is
<code>PingPong.exe</code>):</p>
<ul>
<li><code>PingPong.coverage</code>. This file contains the code coverage data that can be read by Visual Studio.
  To do so, load it as a file into VS, then select Mixed Debugging.</li>
<li>The same Coyote output folder will contain all the instrumented binaries that were used to run the test.
The original binaries are left unchanged.</li>
</ul>
<p>The instrumented binaries are retained because VS requires the matching instrumented binaries to be
able to load the <code>.coverage</code> file. If you want keep track of code-coverage improvements over time
you can use the <code>coyote test --outdir</code> option to collect multiple coverage files in different
locations.</p>
<h3 id="coyote-test-examples">Coyote test examples</h3>
<p>First build the <a href="https://github.com/microsoft/coyote-samples">coyote-samples</a> repo by running the
following command:</p>
<pre><code class="language-plain">powershell -f build.ps1
</code></pre>
<p>Then run <code>coyote</code> with one of the coverage flags, as well as the other options you want. Here are
some minimal examples:</p>
<pre><code class="language-plain">coyote test ./bin/net5.0/Monitors.exe -i 10 --coverage
</code></pre>
<p>This will create the directory <code>./bin/net5.0/Output/Monitors.exe/CoyoteOutput/</code>, then it
generates coverage files for code coverage which you can load into Visual Studio to see the results.</p>
<pre><code class="language-plain">coyote test ./bin/net5.0/Monitors.exe -i 10 -coverage activity  -o &quot;/Coyote_Coverage/Monitors&quot;
</code></pre>
<p>This will create the directory <code>/Coyote_Coverage/Monitors/CoyoteOutput</code>, then it generates only
activity coverage.</p>
<pre><code class="language-plain">coyote test ./bin/net5.0/Monitors.exe -i 10 --coverage code activity-debug
</code></pre>
<p>This generates code and activity coverage, including debug activity output.</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<h4 id="error-vsp1394-could-not-start-profile-monitor">Error VSP1394: Could not start profile monitor</h4>
<p>This could happen if you are trying to run <code>coyote test</code> from a current directory that contains
conflicting binaries from the ones you are testing. Try <code>cd</code> to some other location and run <code>coyote
test</code> with a full path to the binary being tested.</p>
<h4 id="exception-thrown-systembadimageformatexception-in-systemprivatecorelibdll">Exception thrown: &lsquo;System.BadImageFormatException&rsquo; in System.Private.CoreLib.dll</h4>
<p>This could happen on a .NET Core build if you are referencing a <em>.exe instead of the </em>.dll assembly
for testing.</p>
<h4 id="error-could-not-find-dependent-assembly">Error: Could not find dependent assembly &hellip;</h4>
<p>You may need to add <code>--instrument</code> or <code>--instrument-list</code> option to specify the location of that
additional assembly.</p>
<h4 id="code-coverage-is-empty">Code coverage is empty</h4>
<p>If a .coverage file is produced but it is empty, and contains no coverage information then try
running <code>VSInst</code> manually and check for any errors.</p>

    <br>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../generate-dgml/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../generate-dgml/" class="btn btn-xs btn-link">
        Generate DGML diagrams
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../liveness-checking/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../liveness-checking/" class="btn btn-xs btn-link">
        Find liveness bugs effectively
      </a>
    </div>
    
  </div>

      <br>
  </div>
</div>

<footer class="wm-page-content">
  

<section class="footer-join pt-40 pb-80">
  <div class="container-fluid">
    <div class="row text-center">
      <div class="col-sm-8 col-sm-offset-2">
      </div>
    </div>
    <div class="row">
   </div>
  </div>
</section>
<section class="footer-dark pt-60">
  <div class="container-fluid">
    <div class="row">
      <div class="hidden-xs col-sm-5 col-lg-6">
        <a href="" title="homepage" class="logo-footer">
          <img src="/coyote/assets/images/icon.png" alt="Coyote">
        </a>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Coyote</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/">Home</a></li>
            <li><a href="/coyote/get-started/install/">Install</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Resources</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/tutorials/first-concurrency-unit-test/">Getting started</a></li>
            <li><a href="/coyote/tutorials/overview/">Tutorials</a></li>
            <li><a href="/coyote/ref/Microsoft.Coyote">API documentation</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Community</h4>
          <ul class="list-unstyled">
            <li><a href="https://github.com/microsoft/coyote/"><i class="fa fa-github"></i>
GitHub</a></li>
            <li><a href="https://twitter.com/coyote_dev" target="_blank"><i class="fa fa-twitter"></i> Twitter</a></li>
            <li><a href="https://gitter.im/microsoft/coyote" target="_blank">Gitter</a></li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="row footnote pt-50 pb-20">
      <div class="col-sm-12">
        <hr>
      </div>
      <div class="col-sm-6">
        <ul class="list-unstyled list-inline footnote-copy">
          <li><a href="https://privacy.microsoft.com/en-us/privacystatement/" target="_blank">Privacy</a></li>
          <li><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/copyright/default.aspx" target="_blank">Terms of Use</a></li>
          <li><a href="https://github.com/microsoft/coyote/blob/main/LICENSE" target="_blank">License</a></li>
          <li><a href="javascript:manageCookies()">Cookies</a></li>
        </ul>
      </div>
      <div class="col-sm-6 text-right footnote-copy">
        <ul class="list-unstyled list-inline">
          <li><span id="copyright"></span></li>
          <li><a href="https://www.microsoft.com/" target="_blank"><img class="img-responsive" src="/coyote/assets/images/microsoft-logo.svg?v=3" alt="Microsoft">&nbsp;</a></li>
        </ul>
      </div>
    </div>
  </div>
</section>
</footer>


<script type="text/javascript">
    $(document).ready(function () {
      $('table').each(function () {
        $(this).addClass("table");
        $(this).addClass("table-bordered");
        $(this).addClass("table-striped");
        $(this).addClass("table-condensed");
      });

    });
</script>

</body>
</html>