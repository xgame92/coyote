<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://microsoft.github.io/coyote/concepts/tasks/synchronized-block/">
    <link rel="shortcut icon" href="/coyote/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Synchronized block - Coyote</title>
    <link href="/coyote/css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="/coyote/css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="/coyote/css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="/coyote/css/highlight.css">
    <link href="../../../css/main.css" rel="stylesheet">
    <link href="../../../css/player-controls.css" rel="stylesheet">
    <link href="../../../css/syntax.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="/coyote/js/jquery-3.2.1.min.js"></script>
    <script src="/coyote/js/bootstrap-3.3.7.min.js"></script>
    <script src="/coyote/js/highlight.pack.js"></script>
    <script src="https://consentdeliveryfd.azurefd.net/mscc/lib/v2/wcp-consent.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '/coyote/';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Controlled synchronized block", url: "#_top", children: [
          ]},
          {title: "Why is a synchronized block necessary?", url: "#why-is-a-synchronized-block-necessary", children: [
          ]},
          {title: "How do you use it?", url: "#how-do-you-use-it", children: [
          ]},
          {title: "Sample", url: "#sample", children: [
          ]},
        ];

    </script>
    <script src="/coyote/js/base.js"></script>
      <script src="../../../assets/js/analytics.js"></script>
      <script src="../../../assets/js/plugins.js"></script>
      <script src="../../../assets/js/animate_trace.js"></script>
      <script src="../../../assets/js/animation.js"></script>
      <script src="../../../assets/js/progress_bar.js"></script>
      <script src="../../../assets/js/trace_model.js"></script>
      <script src="../../../assets/js/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>

<div id="cookie-banner"></div>


<div class="wrapper wm-page-content">
  <div class="container-fluid">
    <a name="_top"></a>
      

      

      <h2 id="controlled-synchronized-block">Controlled synchronized block</h2>
<p>The Coyote asynchronous tasks programming model provides a
<code>Microsoft.Coyote.Tasks.SynchronizedBlock</code> type that can be used to synchronize multiple tasks
around access to a shared resource. In production this construct is a thin wrapper on
<code>System.Threading.Monitor</code>, and during testing, the <code>SynchronizedBlock</code> is automatically replaced
with a controlled mocked version so that Coyote can explore the scheduling and interleaving of
asynchronous operations that are synchronized this way.</p>
<h2 id="why-is-a-synchronized-block-necessary">Why is a synchronized block necessary?</h2>
<p>C# provides a built in <code>lock</code> keyword that uses <code>System.Threading.Monitor</code> under the covers. This
keyword is often used to protect local state from data race conditions like this:</p>
<pre><code class="language-csharp">class Foo
{
    int count;
    object syncObject = new object();

    public int Increment()
    {
        lock(syncObject)
        {
            return ++count;
        }
    }
}
</code></pre>
<p>The <code>++operator</code> is not atomic, and therefore it is not thread safe, so the lock statement ensures
that it becomes an atomic operation and so now the <code>Increment</code> method can be safely used in parallel
situations. For added convenience, this <code>lock</code> statement is also re-entrant, so your class can call
another method that also enters the lock and this is fine.  This makes it easier to manage code
reuse within your class.</p>
<p>The <code>Monitor</code> class also has a very useful feature in the <code>Wait</code> and <code>Pulse</code> and <code>PulseAll</code> methods
that is hard to replace with anything else.  In this case one task can <code>Wait</code> while it is inside the
<code>lock</code> for another task to signal it using <code>Pulse</code>.  The <code>Wait</code> call releases the lock so another
task can get the lock and call <code>Pulse</code>, when the lock is released, the waiting task can proceed
as it now has the lock.  These primitives form the core of very useful &ldquo;synchronization&rdquo; logic.</p>
<p>Note that it is very important to also point out that C# does not allow <code>await</code> keyword to be used
inside a <code>lock</code> statement as this can lead to deadlocks.</p>
<h2 id="how-do-you-use-it">How do you use it?</h2>
<p>Coyote provides a drop in replacement for <code>System.Threading.Monitor</code> called
<code>Microsoft.Coyote.Tasks.SynchronizedBlock</code>. To get Coyote test control over your synchronized
blocks simply replace:</p>
<pre><code class="language-csharp">lock (this.syncObject)
</code></pre>
<p>with:</p>
<pre><code class="language-csharp">using (var monitor = SynchronizedBlock.Lock(this.syncObject))
</code></pre>
<p>and replace calls to <code>System.Threading.Monitor.Wait</code> and <code>System.Threading.Monitor.Pulse</code> with
calls to the new variable <code>monitor.Wait</code> and <code>monitor.Pulse</code> instead. Then when you run your
<code>coyote test</code> on this code you will get systematic testing of all interleavings around this lock.</p>
<p>Note: you must also avoid using <code>await</code> on asynchronous tasks inside a <code>SynchronizedBlock.Lock</code>. If
Coyote detects any task switching inside a synchronized block you will see an error message saying
<em>&ldquo;Object synchronization method was called from a task that did not create this
SynchronizedBlock&rdquo;</em>.</p>
<p>Bugs involving <code>System.Threading.Monitor</code> can be extremely tricky to debug due to their
<a href="https://en.wikipedia.org/wiki/Heisenbug">heisenbug</a> nature. Coyote testing eliminates this problem
and can given you clear 100% reproducible bug schedules that you can replay as slowly as you need
to see what is really going on leading up to such bugs.</p>
<h2 id="sample">Sample</h2>
<p>For a complete example see the <a href="https://cloudblogs.microsoft.com/opensource/2020/07/14/extreme-programming-meets-systematic-testing-using-coyote/">Extreme Programming meets systematic testing using
Coyote</a>
and the associated <a href="https://github.com/microsoft/coyote-samples/tree/main/BoundedBuffer">BoundedBuffer example source code</a>.</p>

    <br>
      

      <br>
  </div>
</div>

<footer class="wm-page-content">
  

<section class="footer-join pt-40 pb-80">
  <div class="container-fluid">
    <div class="row text-center">
      <div class="col-sm-8 col-sm-offset-2">
      </div>
    </div>
    <div class="row">
   </div>
  </div>
</section>
<section class="footer-dark pt-60">
  <div class="container-fluid">
    <div class="row">
      <div class="hidden-xs col-sm-5 col-lg-6">
        <a href="" title="homepage" class="logo-footer">
          <img src="/coyote/assets/images/icon.png" alt="Coyote">
        </a>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Coyote</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/">Home</a></li>
            <li><a href="/coyote/get-started/install/">Install</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Resources</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/tutorials/first-concurrency-unit-test/">Getting started</a></li>
            <li><a href="/coyote/tutorials/overview/">Tutorials</a></li>
            <li><a href="/coyote/ref/Microsoft.Coyote">API documentation</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Community</h4>
          <ul class="list-unstyled">
            <li><a href="https://github.com/microsoft/coyote/"><i class="fa fa-github"></i>
GitHub</a></li>
            <li><a href="https://twitter.com/coyote_dev" target="_blank"><i class="fa fa-twitter"></i> Twitter</a></li>
            <li><a href="https://gitter.im/microsoft/coyote" target="_blank">Gitter</a></li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="row footnote pt-50 pb-20">
      <div class="col-sm-12">
        <hr>
      </div>
      <div class="col-sm-6">
        <ul class="list-unstyled list-inline footnote-copy">
          <li><a href="https://privacy.microsoft.com/en-us/privacystatement/" target="_blank">Privacy</a></li>
          <li><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/copyright/default.aspx" target="_blank">Terms of Use</a></li>
          <li><a href="https://github.com/microsoft/coyote/blob/main/LICENSE" target="_blank">License</a></li>
          <li><a href="javascript:manageCookies()">Cookies</a></li>
        </ul>
      </div>
      <div class="col-sm-6 text-right footnote-copy">
        <ul class="list-unstyled list-inline">
          <li><span id="copyright"></span></li>
          <li><a href="https://www.microsoft.com/" target="_blank"><img class="img-responsive" src="/coyote/assets/images/microsoft-logo.svg?v=3" alt="Microsoft">&nbsp;</a></li>
        </ul>
      </div>
    </div>
  </div>
</section>
</footer>


<script type="text/javascript">
    $(document).ready(function () {
      $('table').each(function () {
        $(this).addClass("table");
        $(this).addClass("table-bordered");
        $(this).addClass("table-striped");
        $(this).addClass("table-condensed");
      });

    });
</script>

</body>
</html>